language: android
dist: trusty
android:
  components:
    - tools
    - platform-tools
    - android-16
    - sys-img-armeabi-v7a-android-16

  licenses:
    - 'android-sdk-preview-license-52d11cd2'
    - 'android-sdk-license-e6a904e8'

# From Travis CI's guide on how to improve Gradle caching
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

# Start emulator early so it's ready when the build is done
before_install:
  - mkdir $ANDROID_HOME/licenses
  - echo 24333f8a63b6825ea9c5514f83c2829b004d1fee > $ANDROID_HOME/licenses/android-sdk-license
  - sdkmanager 'cmdline-tools;2.1'
  - $ANDROID_HOME/cmdline-tools/2.1/bin/sdkmanager emulator
  - echo no | avdmanager create avd --force --name test --package 'system-images;android-16;default;armeabi-v7a'
  - $ANDROID_HOME/emulator/emulator -avd test -no-audio -no-window &
  - $ANDROID_HOME/cmdline-tools/2.1/bin/sdkmanager platform-tools
  - $ANDROID_HOME/cmdline-tools/2.1/bin/sdkmanager 'build-tools;30.0.2'
  - $ANDROID_HOME/cmdline-tools/2.1/bin/sdkmanager 'platforms;android-19'

before_script:
  - android-wait-for-emulator
  # Disable animations
  - adb shell settings put global window_animation_scale 0 &
  - adb shell settings put global transition_animation_scale 0 &
  - adb shell settings put global animator_duration_scale 0 &
  - adb shell input keyevent 82 &

script:
  - "find $ANDROID_HOME -name source.properties || true"
  - env
  - ./gradlew build
  - ./gradlew test
  - ./gradlew connectedCheck
